<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Auditing - OrientDB</title>


        <!-- Custom HTML head -->

        <meta name="description" content="OrientDB documentation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OrientDB</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="auditing"><a class="header" href="#auditing">Auditing</a></h1>
<p>Starting in OrientDB 2.1, the Auditing component is part of the <a href="http://www.orientechnologies.com/orientdb-enterprise/">Enterprise Edition</a>. This page refers to the Auditing feature and how to work with it. The Studio web tool provides a GUI for Auditing that makes configuration easier. Look at the <a href="../studio/server-management/Studio-Auditing.html">Auditing page in Studio</a>.</p>
<p>By default all the auditing logs are saved as documents of class <code>AuditingLog</code>. If your account has enough privileges, you can directly query the auditing log. Example on retrieving the last 20 logs: <code>select from AuditingLog order by @rid desc limit 20</code>.</p>
<p><strong>OrientDB 2.2</strong>
Starting in OrientDB 2.2, all auditing logs are now stored in the <a href="../internals/System-Database.html">system database</a>.  The auditing log for each database is stored in a derived class of the <code>AuditingLog</code> class with this format: <em>databaseName</em>OAuditingLog.</p>
<p>As an example, if you have a database called <em>MyDB</em>, then the class name will be <code>MyDBOAuditingLog</code>.</p>
<p>Using the previous example to retrieve the last 20 log entries for a specific database, do this from within the system database:
<code>select from MyDBOAuditingLog order by @rid desc limit 20</code></p>
<h2 id="security-first"><a class="header" href="#security-first">Security First</a></h2>
<p>For security reasons, no roles should be able to access the <code>AuditingLog</code> records. For this reason before using Auditing assure to revoke any privilege on the <code>AuditingLog</code> cluster. You can do that from Studio, security panel, or via SQL by using the <a href="../sql/SQL-Revoke.html">SQL REVOKE</a> command. Here's an example of revoking any access to the writer and reader roles:</p>
<pre><code class="language-sql">REVOKE ALL ON database.cluster.auditinglog FROM writer
REVOKE ALL ON database.cluster.auditinglog FROM reader
</code></pre>
<p><strong>OrientDB 2.2</strong>
This is no longer required starting in 2.2, since all auditing logs are stored in the system database.  No local database user has access to the auditing logs stored in the system database.  To grant access, a <a href="../internals/System-Users.html"><em>system user</em></a> must be created in the system database with the appropriate role and permissions.</p>
<h2 id="polymorphism"><a class="header" href="#polymorphism">Polymorphism</a></h2>
<p>OrientDB schema is polymorphic (taken from the Object-Oriented paradigm). This means that if you have the class "Person" and the two classes "Employee" and "Provider" that extend "Person", all the auditing settings on "Person" will be inherited by "Employee" and "Provider" (if the checkbox "polymorphic" is enabled on class "Person").</p>
<p>This makes your life easier when you want to profile only certain classes. For example, you could create an abstract class "Profiled" and let all the classes you want to profile extend it. Starting from v2.1, OrientDB supports multiple inheritance, so it's not a problem extending more classes.</p>
<h2 id="securityjson-configuration"><a class="header" href="#securityjson-configuration">security.json Configuration</a></h2>
<p>There are two parts to enabling and configuring the auditing component.  Starting in OrientDB 2.2, there is a <code>security.json</code> configuration file that resides under the <code>config</code> folder.  See the <a href="../security/Security-Config.html">OrientDB Security Configuraton</a> documentation for more details.</p>
<p>The "auditing" section of the <code>security.json</code> file must be enabled for auditing to work.</p>
<p>Note the additional "distributed" section of "auditing" for logging distributed node events.</p>
<h2 id="auditing-configjson-configuration"><a class="header" href="#auditing-configjson-configuration">auditing-config.json Configuration</a></h2>
<p>To configure auditing of a database, create a JSON configuration file with the name <code>auditing-config.json</code> under the database folder. This is the syntax for configuration:</p>
<pre><code class="language-json">{
  "classes": {
    "&lt;class-name&gt;" : {
      "polymorphic": &lt;true|false&gt;,
      "onCreateEnabled": &lt;true|false&gt;, "onCreateMessage": "&lt;message&gt;",
      "onReadEnabled": &lt;true|false&gt;, "onReadMessage": "&lt;message&gt;",
      "onUpdateEnabled": &lt;true|false&gt;, "onUpdateMessage": "&lt;message&gt;",
      "onUpdateChanges": &lt;true|false&gt;,
      "onDeleteEnabled": &lt;true|false&gt;, "onDeleteMessage": "&lt;message&gt;"
    }
  },
  "commands": [
    {
      "regex": "&lt;regexp to match&gt;",
      "message": "&lt;message&gt;"
    }
  ],
  "schema": {
      "onCreateClassEnabled": &lt;true|false&gt;, "onCreateClassMessage": "&lt;message&gt;",
      "onDropClassEnabled": &lt;true|false&gt;, "onDropClassMessage": "&lt;message&gt;"
  }
}
</code></pre>
<h3 id="classes"><a class="header" href="#classes">"classes"</a></h3>
<p>Where:</p>
<ul>
<li><code>classes</code>: contains the mapping per class. A wildcard <code>*</code> represents any class.</li>
<li><code>class-name</code>: class name to configure.</li>
<li><code>polymorphic</code>: If <code>true</code>, the auditing log also uses this class definition for all sub-classes. By default, the class definition is polymorphic.</li>
<li><code>onCreateEnabled</code>: If <code>true</code>, enables auditing of record creation events. Default is <code>false</code>.</li>
<li><code>onCreateMessage</code>: A custom message stored in the <code>note</code> field of the auditing record on create record events. It supports the dynamic binding of values, see "Customizing the Message", below.</li>
<li><code>onReadEnabled</code>: If <code>true</code>, enables auditing of record reading events. Default is <code>false</code>.</li>
<li><code>onReadMessage</code>: A custom message stored in the <code>note</code> field of the auditing record on read record events. It supports the dynamic binding of values, see "Customizing the Message", below.</li>
<li><code>onUpdateEnabled</code>: If <code>true</code>, enables auditing of record updating events. Default is <code>false</code>.</li>
<li><code>onUpdateMessage</code>: A custom message stored in the <code>note</code> field of the auditing record on update record events. It supports the dynamic binding of values, see "Customizing the Message", below.</li>
<li><code>onUpdateChanges</code>: If <code>true</code>, records all the changed field values in the <code>changes</code> property. The default is <code>true</code> if <code>onUpdateEnabled</code> is true.</li>
<li><code>onDeleteEnabled</code>: If <code>true</code>, enables auditing of delete record events. The default is <code>false</code>.</li>
<li><code>onDeleteMessage</code>: A custom message stored in the <code>note</code> field of the auditing record on delete record events. It supports the dynamic binding of values, see "Customizing the Message", below.</li>
</ul>
<h4 id="customing-the-message"><a class="header" href="#customing-the-message">Customing the Message</a></h4>
<ul>
<li><code>${field.&lt;field-name&gt;}</code>, to use the field value. Example: <code>${field.surname}</code> to get the field "surname" from the current record in case of CRUD Auditing of classes.</li>
</ul>
<p>Example to log all the delete operations (<code>class="*"</code>), and log all the CRUD operation on any vertex (<code>class="V" and polymorphic:true</code>):</p>
<pre><code class="language-json">{
  "classes": {
    "*" : {
      "onDeleteEnabled": true, "onDeleteMessage": "Deleted record of class ${field.@class}"
    },
    "V" : {
      "polymorphic": true,
      "onCreateEnabled": true, "onCreateMessage": "Created vertex of class ${field.@class}",
      "onReadEnabled": true, "onReadMessage": "Read vertex of class ${field.@class}",
      "onUpdateEnabled": true, "onUpdateMessage": "Updated vertex of class ${field.@class}",
      "onDeleteEnabled": true, "onDeleteMessage": "Deleted vertex of class ${field.@class}"
    }
  }
}
</code></pre>
<h3 id="commands"><a class="header" href="#commands">"commands"</a></h3>
<p>Where:</p>
<ul>
<li><code>regexp</code>: If a command is executed that matches the regular expression then the command is logged.</li>
<li><code>message</code>: The optional message that's recorded when the command is logged. It supports the dynamic binding of values, see "Customizing the Message", below.</li>
</ul>
<h4 id="customizing-the-message"><a class="header" href="#customizing-the-message">Customizing the Message</a></h4>
<ul>
<li>The variable <code>${command}</code> will be substituted in the specified message, if command auditing is enabled.</li>
</ul>
<p>Example:
If you want to get all commands regarding update query, you can use standard Java regular expressions (<a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html">see documentation</a>):</p>
<ul>
<li>Regex: <code>^update.*</code></li>
<li>Message: <code>Following update: ${command} executed.</code></li>
</ul>
<p>under "Command Auditing" section.</p>
<h3 id="schema"><a class="header" href="#schema">"schema"</a></h3>
<p>Where:</p>
<ul>
<li><code>onCreateClassEnabled</code>: If <code>true</code>, enables auditing of class creation events. The default is <code>false</code>.</li>
<li><code>onCreateClassMessage</code>: A custom message stored in the <code>note</code> field of the auditing record on class creation events. It supports the dynamic binding of values, look at <a href="Auditing.html#customizing-the-message">Customize the message</a>.</li>
<li><code>onDropClassEnabled</code>: If <code>true</code>, enables auditing of class drop events. The default is <code>false</code>.</li>
<li><code>onDropClassMessage</code>: A custom message stored in the <code>note</code> field of the auditing record on drop class events. It supports the dynamic binding of values, look at <a href="Auditing.html#customizing-the-message">Customize the message</a>.</li>
</ul>
<h4 id="customizing-the-message-1"><a class="header" href="#customizing-the-message-1">Customizing the Message</a></h4>
<ul>
<li>The variable <code>${class}</code> will be substituted in the specified message, if create class or drop class auditing is enabled.</li>
</ul>
<h2 id="log-record-structure"><a class="header" href="#log-record-structure">Log record structure</a></h2>
<p>Auditing Log records have the following structure:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th><th>Values</th></tr></thead><tbody>
<tr><td><code>date</code></td><td>DATE</td><td>Date of execution</td><td>-</td></tr>
<tr><td><code>user</code></td><td>LINK</td><td>User that executed the command. Can be <code>null</code> if internal user has been used</td><td>-</td></tr>
<tr><td><code>operation</code></td><td>BYTE</td><td>Type of operation</td><td>0=READ, 1=UPDATE, 2=DELETE, 3=CREATE, 4=COMMAND</td></tr>
<tr><td><code>record</code></td><td>LINK</td><td>Link to the record subject of the log</td><td>-</td></tr>
<tr><td><code>note</code></td><td>STRING</td><td>Optional message</td><td>-</td></tr>
<tr><td><code>changes</code></td><td>MAP</td><td>Only for UDPATE operation, contains the map of changed fields in the form <code>{"from":&lt;old-value&gt;, "to":&lt;new-value&gt;}</code></td><td>-</td></tr>
</tbody></table>
</div>
<p><strong>OrientDB 2.2</strong>
Starting in 2.2, the <em>AuditingLog</em> class has changed slightly.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th><th>Values</th></tr></thead><tbody>
<tr><td><code>database</code></td><td>STRING</td><td>The name of the database of the logging event.</td><td>-</td></tr>
<tr><td><code>date</code></td><td>DATE</td><td>Date of execution</td><td>-</td></tr>
<tr><td><code>user</code></td><td>STRING</td><td>The name of the user that executed the command.  This type has changed to a String and now supports system users.</td><td>-</td></tr>
<tr><td><code>operation</code></td><td>BYTE</td><td>Type of operation</td><td>0=READ, 1=UPDATE, 2=DELETE, 3=CREATE, 4=COMMAND</td></tr>
<tr><td><code>record</code></td><td>LINK</td><td>Link to the record subject of the log.</td><td>-</td></tr>
<tr><td><code>note</code></td><td>STRING</td><td>Optional message</td><td>-</td></tr>
<tr><td><code>changes</code></td><td>MAP</td><td>Only for UDPATE operation, contains the map of changed fields in the form <code>{"from":&lt;old-value&gt;, "to":&lt;new-value&gt;}</code></td><td>-</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ee/Enterprise-Edition.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../internals/Internals.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ee/Enterprise-Edition.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../internals/Internals.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
