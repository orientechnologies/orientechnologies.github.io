<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>liveQuery() - OrientDB</title>


        <!-- Custom HTML head -->

        <meta name="description" content="OrientDB documentation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OrientDB</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="orientjs---livequery"><a class="header" href="#orientjs---livequery">OrientJS - <code>liveQuery()</code></a></h1>
<p>When using traditional queries, such as those called with <code>db.query()</code> and <code>db.select()</code> you only get data that is current at the time the query is issued.  Beginning in version 2.1, OrientDB now supports <a href="../java/Live-Query.html">Live Queries</a>, where in issuing the query you tell OrientDB you want it to push affecting changes to your application.</p>
<p>You can execute Live Queries using the <code>db.liveQuery()</code> method with a <a href="../sql/SQL-Live-Select.html"><code>LIVE SELECT</code></a> statement passed as its argument.</p>
<p>From OrientDB 2.2.x in order to make live query works the token must be enabled. See <a href="OrientJS-Server.html#using-tokens">here</a></p>
<h2 id="understanding-live-queries"><a class="header" href="#understanding-live-queries">Understanding Live Queries</a></h2>
<p>Traditional queries provide you with information that is current at the time the query is issued.  In most cases, such as well pulling statistical data on long-dead ball players like Ty Cobb, this behavior is sufficient to your needs.  But, what if about when you need real time information.</p>
<p>For instance, what if in addition to historical data you also want your application to serve real-time information about baseball games as they're being played.</p>
<p>With the traditional query, you would have to reissue the query within a set interval to update the application.  Live Queries allow you to register events, so that your application performs addition operations in the event of an <a href="../sql/SQL-Insert.html"><code>INSERT</code></a>, <a href="../sql/SQL-Delete.html"><code>DELETE</code></a>, or <a href="../sql/SQL-Update.html"><code>UPDATE</code></a>.</p>
<p>For example, say that you have a web application that uses the baseball database.  The application serves the current score and various other stats for the game.  Whenever your back-end system inserts new records for the game, you can execute a function to update the display information.</p>
<blockquote>
<p>For more information on event handlers in OrientJS, see <a href="OrientJS-Events.html">Events</a>.</p>
</blockquote>
<h2 id="working-with-live-queries"><a class="header" href="#working-with-live-queries">Working with Live Queries</a></h2>
<p>In OrientJS, Live Queries are called using the <code>db.liveQuery()</code> method.  This is similar to <code>db.query()</code> in that you use it to issue the raw SQL of a <a href="../sql/SQL-Live-Select.html"><code>LIVE SELECT</code></a> statement.  Unlike <code>db.query()</code>, you can assign event handlers to <code>db.liveQuery</code> using the <code>on()</code> method.</p>
<p>For instance,</p>
<pre><code class="language-js">db.liveQuery('LIVE SELECT FROM V')
   .on('live-update', function(data){
      var myRecord = data.content;
   });
</code></pre>
<p>This would assign to the variable <code>myRecord</code> object data in response to each update made to the class <code>V</code>.  For instance,</p>
<pre><code class="language-js">db.update('#12:97')
   .set({
      ba: 0.321
   }).one(); 
</code></pre>
<p>When your application runs this method, it also sets the <code>myRecord</code> variable to</p>
<pre><code class="language-js">var myRecord = {
   content: {
      @rid: $12:97,
      ba: 0.321
   },
   operation: update
};
</code></pre>
<p>You can then use this information in your code to determine what your application should do in response.</p>
<h3 id="running-events-on-insert"><a class="header" href="#running-events-on-insert">Running Events on Insert</a></h3>
<p>When you pass the <code>liveQuery().on()</code> method the string <code>live-insert</code>, it executes the function argument whenever an insert operation is performed on the class.</p>
<p>For instance, say that you want to pass statistics on new plays to your game monitoring application:</p>
<pre><code class="language-js">db.liveQuery('LIVE SELECT FROM Game '
             + WHERE game_id = "201606-001"')
   .on('live-insert', function(data){
      var gameStat = data.content;
		  if (gameStat.score != currentScore){
         var score = updateScore(gameStat.score);
         console.log("Updated Score:", score);
      }
   });
</code></pre>
<p>Here, the Live Query registers an event to <a href="../sql/SQL-Insert.html"><code>INSERT</code></a> events on the <code>Game</code> class where the <code>game_id</code> property equals the one currently being played.  Whenever the back-end service inserts data on a new play, the application checks for changes in the score.  When either team scores, it passes the score to an <code>updateScore</code> function, which we might use to trigger a notification event in the web browser to let the user know their team scored run or runs.</p>
<h3 id="running-events-on-delete"><a class="header" href="#running-events-on-delete">Running Events on Delete</a></h3>
<p>When you pass the <code>liveQuery().on()</code> method the string <code>live-delete</code>, it executes the function argument whenever a delete operation is performed on the class.</p>
<p>For instance, for the baseball database, say that you only calculate player batting averages after each game instead of on the fly.  You might set up an event to process new batting averages whenever the stored values are deleted.</p>
<pre><code class="language-js">db.liveQuery('LIVE SELECT rid, name, ba FROM Player`)
   .on('live-delete' function(data.content){
      var player = data.content;
			var newBA = genBatAvg(player.rid);
      db.update(player.rid)
         .set({
            ba: newBa
         }).one()
         then(
            function(update){
               console.log("Updated BA: " update.name);
            }
         );
   });
</code></pre>
<p>Now, whenever your application issues a <a href="OrientJS-Query-Delete.html"><code>delete()</code></a> statement against the player's batting average, it triggers this function to generate a new batting average and runs the <a href="OrientJS-Query-Update.html"><code>update()</code></a> method to apply the changes to the player's record.  Once this operation is complete, all queries made against this class will use the new data.</p>
<h3 id="running-events-on-updates"><a class="header" href="#running-events-on-updates">Running Events on Updates</a></h3>
<p>When you pass the <code>liveQuery().on()</code> method the string <code>live-update</code>, it executes the function argument whenever an update operation is performed on the class.</p>
<p>For instance, say that as a security precaution, you would like your application to email you whenever certain key changes are made to the <code>OUser</code> class, such as an update that escalates user privileges.  You might use something like this,</p>
<pre><code class="language-js">db.liveQuery('LIVE SELECT FROM OUser')
   .on('live-update', function(data){
      var report = reportChange(data.content);
      console.log("Report:", report);
   });
</code></pre>
<p>When your application contains this code, any changes on the database that issue <a href="../sql/SQL-Update.html"><code>UPDATE</code></a> queries to the <code>OUser</code> class are passed to the <code>reportChange()</code> function, which you can use to determine whether or not the changes are legitimate and if they're not, what you want it to do or who it should notify about suspicious activity.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../orientjs/OrientJS-Query-Insert.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../orientjs/OrientJS-Query-Select.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../orientjs/OrientJS-Query-Insert.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../orientjs/OrientJS-Query-Select.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>


        
        <img referrerpolicy="unsafe-url" src="https://tglman.org/OrientDB/matomo.php?idsite=7&amp;rec=1" style="border:0" alt="" />


        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
