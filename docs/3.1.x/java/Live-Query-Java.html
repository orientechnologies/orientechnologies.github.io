<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Live Query in Java - OrientDB</title>


        <!-- Custom HTML head -->

        <meta name="description" content="OrientDB documentation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OrientDB</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="using-live-queries-in-java"><a class="header" href="#using-live-queries-in-java">Using Live Queries in Java</a></h1>
<p>In order to implement the Live Query feature in your Java applications, you need two elements:</p>
<ul>
<li><a href="#listener"><strong>Listener</strong></a> The class that asynchronously receives the result-set from the query.</li>
<li><a href="#statement"><strong>Statement</strong></a> The SELECT query statement that OrientDB executes to define the records to be monitored.</li>
</ul>
<h2 id="listener"><a class="header" href="#listener">Listener</a></h2>
<p>When developing a listener for your query, you must implement the <code>OLiveQueryResultListener</code> class.  It must have a callback method that receives the Live Query token and the record that was modified with the operation that occurred, (that is, <a href="../sql/SQL-Insert.html"><code>INSERT</code></a>, <a href="../sql/SQL-Update.html"><code>UPDATE</code></a>, or <a href="../sql/SQL-Delete.html"><code>DELETE</code></a>.</p>
<pre><code class="language-java">class MyLiveQueryListener implements OLiveQueryResultListener {

    @Override
    public void onCreate(ODatabaseDocument database, OResult data) {
       // your record create logic here
    }

    @Override
    public void onUpdate(ODatabaseDocument database, OResult before, OResult after) {
       // your record update logic here
    }

    @Override
    public void onDelete(ODatabaseDocument database, OResult data) {
       // your record delete logic here
    }

    @Override
    public void onError(ODatabaseDocument database, OException exception) {
       // your error logic here
    }

    @Override
    public void onEnd(ODatabaseDocument database) {
       // this is invoked when you unsubscribe
    }
  }
</code></pre>
<h2 id="live-query-execution"><a class="header" href="#live-query-execution">Live Query execution</a></h2>
<p>In order to actually execute a Live Query, you can use the <code>db.live(query, listener, parameters...)</code> method, passing it the SQL query statement.  For instance, assume you have an active <code>ODatabaseSession</code> instance tied to the <code>db</code> object and that you want a Live Query to update a webpage that shows current messages for a user with the Record ID #12:40.</p>
<pre><code class="language-java">// Instantiate Query Listener
OLiveQueryResultListener listener = new MyLiveQueryListener();

// Execute Live Query
OLiveQueryMonitor monitor = db.live("SELECT FROM Messages WHERE toAddress = #12:40"", listener);

// and eventually stop the live query, when you don't need it anymore
monitor.unSubscribe();
</code></pre>
<p>From now on, your application receives updates from OrientDB whenever changes are made to the result-set.  So, for instance, say that someone connected to another client where to execute an <a href="../sql/SQL-Insert.html"><code>INSERT</code></a> statement, like</p>
<pre><code class="language-java">// Send Message
db.command("INSERT INTO Messages SET toAddress = #12:40, "
      + "fromAddress = 12:80, "
      + "subject = 'Re: Recent Events'"
   );
</code></pre>
<p>When the client executes this command on OrientDB, OrientDB in turn invokes the <code>onCreate()</code> method on your listener class.</p>
<h3 id="unsubscribe"><a class="header" href="#unsubscribe">Unsubscribe</a></h3>
<p>Live Queries remain active indefinitely, until the server shuts down or you unsubscribe from the token.  As described above, the live query execution returns a monitor object, that can be used to unsubscribe from the live query.</p>
<pre><code class="language-java">monitor.unSubscribe();
</code></pre>
<p>From now on, your application no longer receives updates on this query.</p>
<h1 id="legacy-live-queries"><a class="header" href="#legacy-live-queries">Legacy Live Queries</a></h1>
<p>OrientDB v 3.0 still supports the legacy APIs, that were the default implementation in v 2.2.
We strongly suggest to avoid using these APIs, as they will be removed in next major versions.</p>
<h2 id="legacy-listener"><a class="header" href="#legacy-listener">Legacy Listener</a></h2>
<p>When developing a listener for your query, you must implement the <code>OLiveResultListener</code> class.  It must have a callback method that receives the Live Query token and the record that was modified with the operation that occurred, (that is, <a href="../sql/SQL-Insert.html"><code>INSERT</code></a>, <a href="../sql/SQL-Update.html"><code>UPDATE</code></a>, or <a href="../sql/SQL-Delete.html"><code>DELETE</code></a>.</p>
<pre><code class="language-java">class MyLiveQueryListener implements OLiveResultListener {

   public List&lt;ORecordOperation&gt; ops = new 
         ArrayList&lt;ORecordOperation&gt;();

   @Override
   public void onLiveResult(
         int LiveToken, 
         ORecordOperation iOp)
         throws OException {
   
      System.out.println(
         "New Result from server for live query "
         + iLiveToken);
      System.out.println("operation: " + iOp.type);
      System.out.println("content: " + iOp.record);
   }

   public void onError(int iLiveToken){
      System.out.println(
         "Live query terminated due to error"
      );
   }

   public void onUnsubscribe(int iLiveToken){
      System.out.println(
         "Live query terminated with unsubscribe."
      );
   }
}
</code></pre>
<h2 id="legacy-live-query-execution"><a class="header" href="#legacy-live-query-execution">Legacy Live Query execution</a></h2>
<p>In order to actually execute a Live Query, you can use the <code>db.query()</code> method, passing itan <code>OLiveQuery</code> object as an argument with a <a href="../sql/SQL-Live-Select.html"><code>LIVE QUERY</code></a> SQL statement.  For instance, assume you have an active <code>ODatabaseDocumentTx</code> instance tied to the <code>db</code> object and that you want a Live Query to update a webpage that shows current messages for a user with the Record ID #12:40.</p>
<pre><code class="language-java">// Instantiate Query Listener
MyLiveQueryListener listener = new MyLiveQueryListener();

// Execute Live Query
List&lt;ODocument&gt; result = db.query(
   new OLiveQuery&lt;ODocument&gt;(
      "LIVE SELECT FROM Messages WHERE toAddress = #12:40"
   )
);

// Retrieve Live Query Token
String token = result.get(0).field("token");
</code></pre>
<p>From now on, your application receives updates from OrientDB whenever changes are made to the result-set.  So, for instance, say that someone connected to another client where to execute an <a href="../sql/SQL-Insert.html"><code>INSERT</code></a> statement, like</p>
<pre><code class="language-java">// Send Message
db.command("INSERT INTO Messages SET toAddress = #12:40, "
      + "fromAddress = 12:80, "
      + "subject = 'Re: Recent Events'"
   );
</code></pre>
<p>When the client executes this command on OrientDB, OrientDB in turn invokes the <code>onLiveResult()</code> method on your listener class.  Given the way the code is written in Listener above, your applications prints the following information to standard output:</p>
<pre><code>New result from server for live query 1234567
operation: 3 &lt;- ORecordOperation.CREATED
content: {@RID: "15:20", toAddress: "#12:40", 
fromAddress: "#12:80", subject: "Re: Recent Events"}
</code></pre>
<h3 id="legacy-unsubscribe"><a class="header" href="#legacy-unsubscribe">Legacy Unsubscribe</a></h3>
<p>Live Queries remain active indefinitely, until the server shuts down or you unsubscribe from the token.  In the above section, you use the following line to store the Live Query token in the <code>token</code> variable</p>
<pre><code class="language-java">// Retrieve Live Query Token
String token = result.get(0).field("token");
</code></pre>
<p>You can use this variable with <a href="../sql/SQL-Live-Unsubscribe.html"><code>LIVE UNSUBSCRIBE</code></a> to unsubscribe from the Live Query.</p>
<pre><code class="language-java">db.command(
   new OCommandSQL("LIVE UNSUBSCRIBE " + token))
   .execute();
</code></pre>
<p>From now on, your application no longer receives updates on this query.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../java/Live-Query-Comparison.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../java/Object-Database.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../java/Live-Query-Comparison.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../java/Object-Database.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>


        
        <img referrerpolicy="unsafe-url" src="https://tglman.org/OrientDB/matomo.php?idsite=7&amp;rec=1" style="border:0" alt="" />


        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
